<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Simple Three.js WebXR AR (GLB) / iOS AR Quick Look (USDZ)</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Add some specific styles for the iOS "View in AR" button if needed */
        #iosArLink {
            display: none; /* Hidden by default, shown for iOS */
            padding: 12px 25px;
            font-size: 1.1em;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            text-decoration: none; /* Remove underline for links */
            margin-top: 15px;
            cursor: pointer;
            width: fit-content; /* Adjust width to content */
            margin-left: auto;
            margin-right: auto;
        }
        #iosArLink:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div id="info">
        <h1>Three.js WebXR AR</h1>
        <p id="platform-message">Loading AR...</p>
        <button id="arButton" disabled>Loading AR...</button>
        <a id="iosArLink" rel="ar" href="" download="model1.usdz">View in AR (iOS)</a>
        <p id="status">Waiting for 3D model to load and AR compatibility check...</p>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://threejs.org/build/three.module.js",
                "three/addons/": "https://threejs.org/examples/jsm/"
            }
        }
    </script>
    <script type="module">
        import * as THREE from 'three';
        // Note: Using `three/addons/` for OrbitControls is fine, but for GLTFLoader and ARButton,
        // we'll stick to the unpkg CDN for simplicity to ensure consistent versions with the button.
        // It's generally better to either use importmap for all or direct unpkg for all for consistency.
        import { GLTFLoader } from 'https://unpkg.com/three@0.165.0/examples/jsm/loaders/GLTFLoader.js';
        import { ARButton } from 'https://unpkg.com/three@0.165.0/examples/jsm/webxr/ARButton.js';

        let camera, scene, renderer;
        let controller; // To capture user taps
        let reticle;    // The ring to indicate a detected surface
        let loadedModel; // The GLB model itself

        let hitTestSource = null;
        let hitTestSourceRequested = false;

        const container = document.body;
        const arButton = document.getElementById('arButton');
        const iosArLink = document.getElementById('iosArLink'); // Get the new iOS AR link element
        const statusText = document.getElementById('status');
        const infoDiv = document.getElementById('info');
        const platformMessage = document.getElementById('platform-message'); // New element for messages

        let modelGlbUrl = '';
        let modelUsdzUrl = ''; // To store the USDZ URL

        // Function to detect if the device is iOS
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        }

        // Get model URL from query parameter
        const urlParams = new URLSearchParams(window.location.search);
        modelGlbUrl = urlParams.get('model1'); // Assume 'model' param gives GLB path

        // Infer USDZ path from GLB path, or if explicitly passed, use it.
        // For this specific alteration, we're assuming the GLB URL is passed,
        // and we derive the USDZ by replacing .glb with .usdz
        if (modelGlbUrl) {
            modelUsdzUrl = modelGlbUrl.replace('.glb', '.usdz');
        }


        // --- Conditional AR setup based on platform ---
        if (isIOS()) {
            // iOS Path: Hide WebXR button, show USDZ link
            arButton.style.display = 'none';
            iosArLink.style.display = 'block';
            platformMessage.textContent = 'Tap "View in AR" to launch in Apple AR Quick Look.';

            if (modelUsdzUrl) {
                iosArLink.href = modelUsdzUrl;
                iosArLink.setAttribute('download', modelUsdzUrl.substring(modelUsdzUrl.lastIndexOf('/') + 1));
            } else {
                iosArLink.textContent = 'USDZ Model Not Found';
                iosArLink.disabled = true; // Disable if no USDZ
                platformMessage.textContent = 'Error: USDZ model path missing.';
            }

        } else {
            // Android/Other WebXR Path: Hide USDZ link, proceed with WebXR setup
            iosArLink.style.display = 'none';
            arButton.style.display = 'block';
            platformMessage.textContent = 'This is a simple markerless AR example.';
            
            initWebXR(); // Initialize Three.js/WebXR
            animate();
        }

        function initWebXR() {
            scene = new THREE.Scene();

            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true; // Crucial: Enable WebXR for the renderer
            container.appendChild(renderer.domElement);

            // Add some basic lighting
            const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 3);
            light.position.set(0.5, 1, 0.25);
            scene.add(light);

            // Create the reticle (the little ring that helps place objects)
            reticle = new THREE.Mesh(
                new THREE.RingGeometry(0.08, 0.12, 32).rotateX(-Math.PI / 2),
                new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.8 })
            );
            reticle.matrixAutoUpdate = false; // We'll manually update its position from hit-test results
            reticle.visible = false;
            scene.add(reticle);

            // Load the GLB model using the URL from query param
            const loader = new GLTFLoader();
            if (modelGlbUrl) {
                loader.load(modelGlbUrl, function (gltf) {
                    loadedModel = gltf.scene;
                    loadedModel.scale.set(0.1, 0.1, 0.1); 
                    loadedModel.visible = false; 

                    if (gltf.animations && gltf.animations.length) {
                        const mixer = new THREE.AnimationMixer(loadedModel);
                        gltf.animations.forEach((clip) => {
                            mixer.clipAction(clip).play();
                        });
                        loadedModel.mixer = mixer; 
                    }

                    arButton.textContent = 'START AR';
                    arButton.disabled = false;
                    statusText.textContent = 'Model loaded. Tap "START AR" and point camera at a flat surface.';

                }, undefined, function (error) {
                    console.error('Error loading GLB model:', error);
                    statusText.textContent = 'Error loading 3D model.';
                    arButton.disabled = true;
                });
            } else {
                 console.error("No GLB model URL found for WebXR.");
                 statusText.textContent = "Error: GLB model not specified for WebXR.";
                 arButton.disabled = true;
            }

            // AR Button setup from Three.js examples (handles WebXR session request)
            const button = ARButton.createButton(renderer, { 
                requiredFeatures: ['hit-test'],
            });
            arButton.parentNode.replaceChild(button, arButton); // Replace our placeholder button with the Three.js one

            // Controller for user interaction (tap to place model)
            controller = renderer.xr.getController(0);
            controller.addEventListener('select', onSelect);
            scene.add(controller);

            window.addEventListener('resize', onWindowResize);
        } // End initWebXR

        function onSelect() {
            if (reticle.visible && loadedModel) {
                const placedInstance = loadedModel.clone(); 
                placedInstance.position.setFromMatrixPosition(reticle.matrix);
                placedInstance.quaternion.setFromRotationMatrix(reticle.matrix);
                placedInstance.visible = true; 
                scene.add(placedInstance);
                statusText.textContent = 'Model placed! Tap again to place another.';

                if (loadedModel.mixer) {
                    placedInstance.mixer = new THREE.AnimationMixer(placedInstance);
                    loadedModel.animations.forEach((clip) => {
                        placedInstance.mixer.clipAction(clip).play();
                    });
                }

            } else {
                statusText.textContent = 'Move your device to find a surface to place the model.';
            }
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            // renderer.setAnimationLoop calls render() automatically for WebXR
            // This function is only called if initWebXR runs (i.e., not on iOS)
        }

        function render(timestamp, frame) {
            const delta = 0; // Or use a Clock for precise animation timing
            if (loadedModel && loadedModel.mixer) {
                scene.traverse(obj => {
                    if (obj.mixer) {
                        obj.mixer.update(delta);
                    }
                });
            }

            if (frame) {
                const referenceSpace = renderer.xr.getReferenceSpace();
                const session = renderer.xr.getSession();

                if (!hitTestSourceRequested) {
                    session.requestHitTestSource({ space: referenceSpace }).then(function (source) {
                        hitTestSource = source;
                    });
                    session.addEventListener('end', function () { 
                        hitTestSourceRequested = false;
                        hitTestSource = null;
                        infoDiv.style.display = 'block'; 
                        statusText.textContent = 'AR session ended. Reload to try again.';
                    });
                    hitTestSourceRequested = true;
                    infoDiv.style.display = 'none'; 
                }

                if (hitTestSource) {
                    const hitTestResults = frame.getHitTestResults(hitTestSource);

                    if (hitTestResults.length) {
                        const hit = hitTestResults[0];
                        reticle.visible = true;
                        reticle.matrix.fromArray(hit.transform.matrix); 
                        statusText.textContent = 'Tap screen to place model.';
                    } else {
                        reticle.visible = false;
                        statusText.textContent = 'Move device to find a surface.';
                    }
                }
            }

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>