<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Simple Web AR (GLB/USDZ)</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Specific styles for the iOS "View in AR" button */
        #iosArLink {
            display: none; /* Hidden by default, shown for iOS */
            padding: 15px 30px;
            font-size: 1.2em;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            text-decoration: none; /* Remove underline for links */
            margin-top: 20px;
            cursor: pointer;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        #iosArLink:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }
        #iosArLink:active {
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <div id="info">
        <h1>Augmented Reality Demo</h1>
        <p id="platform-message">Loading AR experience...</p>
        <button id="arButton" disabled>Start AR</button>
        <a id="iosArLink" rel="ar" href="" download="robot.usdz">View in AR (iOS)</a>
        <p id="status">Checking device compatibility and loading model...</p>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://threejs.org/build/three.module.js",
                "three/addons/": "https://threejs.org/examples/jsm/"
            }
        }
    </script>
    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'https://unpkg.com/three@0.165.0/examples/jsm/loaders/GLTFLoader.js';
        import { ARButton } from 'https://unpkg.com/three@0.165.0/examples/jsm/webxr/ARButton.js';

        // --- Configuration for your model ---
        const GLB_MODEL_PATH = 'models/robot.glb';
        const USDZ_MODEL_PATH = 'models/robot.usdz';
        const MODEL_SCALE = 0.1; // Adjust this if your model is too big/small

        // --- Global Variables (for Three.js) ---
        let camera, scene, renderer;
        let controller;
        let reticle;
        let loadedModel;

        let hitTestSource = null;
        let hitTestSourceRequested = false;

        // --- DOM Elements ---
        const container = document.body;
        const arButton = document.getElementById('arButton');
        const iosArLink = document.getElementById('iosArLink');
        const statusText = document.getElementById('status');
        const infoDiv = document.getElementById('info');
        const platformMessage = document.getElementById('platform-message');

        // --- Platform Detection ---
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        }

        // --- Main Initialization Logic ---
        if (isIOS()) {
            // Setup for iOS (AR Quick Look)
            arButton.style.display = 'none'; // Hide WebXR button
            iosArLink.style.display = 'block'; // Show iOS AR link
            platformMessage.textContent = 'Tap "View in AR" to launch in Apple AR Quick Look.';
            statusText.textContent = 'AR experience optimized for iOS native viewer.';

            if (USDZ_MODEL_PATH) {
                iosArLink.href = USDZ_MODEL_PATH;
                // Set download attribute for better naming if user downloads
                iosArLink.setAttribute('download', USDZ_MODEL_PATH.substring(USDZ_MODEL_PATH.lastIndexOf('/') + 1));
            } else {
                iosArLink.textContent = 'USDZ Model Not Found';
                iosArLink.disabled = true; // Disable if no USDZ path
                platformMessage.textContent = 'Error: USDZ model path missing.';
            }

        } else {
            // Setup for Android/Other WebXR-compatible browsers
            iosArLink.style.display = 'none'; // Hide iOS AR link
            arButton.style.display = 'block'; // Show WebXR button
            platformMessage.textContent = 'On supported devices, tap "Start AR" and point your camera at a flat surface.';
            
            initWebXR(); // Initialize Three.js/WebXR
            animate();   // Start the animation loop for WebXR
        }

        // --- Three.js WebXR Specific Functions (only for non-iOS) ---
        function initWebXR() {
            scene = new THREE.Scene();

            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true; // Crucial: Enable WebXR for the renderer
            container.appendChild(renderer.domElement);

            // Basic lighting
            const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 3);
            light.position.set(0.5, 1, 0.25);
            scene.add(light);

            // Reticle for surface detection
            reticle = new THREE.Mesh(
                new THREE.RingGeometry(0.08, 0.12, 32).rotateX(-Math.PI / 2),
                new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.8 })
            );
            reticle.matrixAutoUpdate = false;
            reticle.visible = false;
            scene.add(reticle);

            // Load the GLB model
            const loader = new GLTFLoader();
            loader.load(GLB_MODEL_PATH, function (gltf) {
                loadedModel = gltf.scene;
                loadedModel.scale.set(MODEL_SCALE, MODEL_SCALE, MODEL_SCALE); 
                loadedModel.visible = false; 

                // Handle animations if present
                if (gltf.animations && gltf.animations.length) {
                    const mixer = new THREE.AnimationMixer(loadedModel);
                    gltf.animations.forEach((clip) => {
                        mixer.clipAction(clip).play();
                    });
                    loadedModel.mixer = mixer; 
                }

                arButton.textContent = 'START AR';
                arButton.disabled = false;
                statusText.textContent = 'Model loaded. Tap "START AR" and point camera at a flat surface.';

            }, undefined, function (error) {
                console.error('Error loading GLB model:', error);
                statusText.textContent = 'Error loading 3D model. Please check the console.';
                arButton.disabled = true;
            });

            // Create the WebXR AR button
            const button = ARButton.createButton(renderer, { 
                requiredFeatures: ['hit-test']
            });
            arButton.parentNode.replaceChild(button, arButton);

            // Controller for tap events
            controller = renderer.xr.getController(0);
            controller.addEventListener('select', onSelect);
            scene.add(controller);

            window.addEventListener('resize', onWindowResize);
        }

        function onSelect() {
            if (reticle.visible && loadedModel) {
                const placedInstance = loadedModel.clone(); 
                placedInstance.position.setFromMatrixPosition(reticle.matrix);
                placedInstance.quaternion.setFromRotationMatrix(reticle.matrix);
                placedInstance.visible = true; 
                scene.add(placedInstance);
                statusText.textContent = 'Model placed! Tap again to place another.';

                if (loadedModel.mixer) {
                    placedInstance.mixer = new THREE.AnimationMixer(placedInstance);
                    loadedModel.animations.forEach((clip) => {
                        placedInstance.mixer.clipAction(clip).play();
                    });
                }
            } else {
                statusText.textContent = 'Move your device to find a surface to place the model.';
            }
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            // renderer.setAnimationLoop will call render() automatically during an XR session
        }

        function render(timestamp, frame) {
            // Update animations for any placed models that have a mixer
            const delta = 0; // Use a proper clock for real animation delta
            scene.traverse(obj => {
                if (obj.mixer) {
                    obj.mixer.update(delta);
                }
            });

            if (frame) {
                const referenceSpace = renderer.xr.getReferenceSpace();
                const session = renderer.xr.getSession();

                // Request hit test source once per session
                if (!hitTestSourceRequested) {
                    session.requestHitTestSource({ space: referenceSpace }).then(function (source) {
                        hitTestSource = source;
                    });
                    session.addEventListener('end', function () { 
                        hitTestSourceRequested = false;
                        hitTestSource = null;
                        infoDiv.style.display = 'block'; 
                        statusText.textContent = 'AR session ended. Reload to try again.';
                    });
                    hitTestSourceRequested = true;
                    infoDiv.style.display = 'none'; 
                }

                // Get hit test results to position the reticle
                if (hitTestSource) {
                    const hitTestResults = frame.getHitTestResults(hitTestSource);

                    if (hitTestResults.length) {
                        const hit = hitTestResults[0];
                        reticle.visible = true;
                        reticle.matrix.fromArray(hit.transform.matrix); 
                        statusText.textContent = 'Tap screen to place model.';
                    } else {
                        reticle.visible = false;
                        statusText.textContent = 'Move device to find a surface.';
                    }
                }
            }
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>